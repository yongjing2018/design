
# 充值中的幂等问题
## 一 背景
周末加班，有位同学告诉我出现了充值被翻倍的情况。经了解，采用rabbitMq进行消息通知，然后订阅后1.根据流水号直接更新记录状态；2.直接update用户的账户金额update tbl set blance += xx where id=x； 1和2都在一个事务中。

## 二 问题分析
首先考虑到的事“幂等问题”等处理，很明显出现消息重复消费的问题。另外，就是流程，先更新到目标状态，然后再更新账户余额，如果第二步更新失败，就会导致用户充值了，但是没有记录到问题。

## 三解决方案
1.每次充值都会有唯一的ID（流水号），如果该流水号在受理，就是不应该再由其他的worker受理。
* 处理方式： 需要针对ID对应的版本进行锁定,有2种方式:
+ 第一种是，通过redis插入记录，判断记录是否存在，如果存在则返回0，否则插入然后返回1，需要采用lua完成（保证原子性）。 
+ 第二种通过mysql update table set status=2 where sID = xxx and status=1； 如果更新成功则受理，否则不受理。 
P.S. 此update使用了id和status两个索引。 很容易产生死锁。 【能够保障所有的更新都采用id作为更新条件应该都能避免】

2.针对每次受理，要标识状态，受理中以及对应的TS，如果受理完成，就是在更新处理完成，需要3步。
* 如果出现在第三步有问题？ 就需要不断的重试，需要记录大量的日志。
* 如果出现在第二步有问题？需要有个线程针对业务进行检查，如果出现600s没有处理完成的，就需要在次发起，处理请求。 发起之前需要向处理改记录的worker询问处理状态。如果以应处理中，则放弃。如果是未知状态。
